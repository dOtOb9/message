# GPT 自動チャット分析機能 - 使用ガイド

## 概要
このアプリケーションに**完全自動のGPT分析機能**が統合されました。チャット履歴が更新されるたびに自動的に内容を分析し、必要に応じてToDoアイテムを生成して元のチャットにリンクします。ユーザーが特別な操作をする必要は一切ありません。

## 主な機能

### 🤖 完全自動ToDo生成
- **バックグラウンド処理**: ユーザーの会話を邪魔することなく、完全に背景で動作
- **リアルタイム監視**: 新しいメッセージが3件以上追加されると、3秒後に自動分析を開始  
- **スマート判定**: GPT-3.5-turboで軽量な事前分析を行い、ToDo生成が必要か判定（信頼度70%以上で実行）
- **詳細分析**: 必要と判定された場合のみGPT-4でフル分析を実行してToDo生成
- **非侵入的**: 手動ボタンや通知なし、静かに動作
1. [OpenAI Platform](https://platform.openai.com/)にアクセス
2. アカウントを作成またはログイン
3. [API Keys](https://platform.openai.com/api-keys)ページでAPIキーを生成

### 2. 環境変数の設定
`.env.local`ファイルを開いて、取得したAPIキーを設定してください：

```env
EXPO_PUBLIC_OPENAI_API_KEY=your-actual-api-key-here
```

**重要**: `your-actual-api-key-here`を実際のAPIキーに置き換えてください。

### 3. アプリの再起動
環境変数を変更したら、開発サーバーを再起動してください：

```bash
npx expo start --clear
```

## 動作仕様

### 自動分析のトリガー条件
1. **新規メッセージが3件以上追加**
2. **3秒間の待機時間**（連続入力への配慮）
3. **事前判定で必要性を確認**（コスト最適化）

### 2段階分析システム
1. **第1段階**: GPT-3.5-turboで軽量な判定（信頼度70%以上で次の段階へ）
2. **第2段階**: GPT-4でフル分析とToDo生成

### 分析対象の判定基準
- 具体的な作業や依頼
- 期限や予定の設定  
- 準備・調査・購入の必要性
- フォローアップや連絡事項
- 決定事項の実行要求

## 機能説明

### 🤖 自動ToDo生成
GPTは以下のような内容をチャット履歴から抽出してToDoアイテムを自動生成します：

1. **作業やタスクの依頼**
   - 例：「明日までに資料をまとめてください」
   
2. **会議や打ち合わせの予定**
   - 例：「来週の会議の準備をする必要があります」

3. **研究や調査の必要性**
   - 例：「この件について詳しく調べてみよう」

4. **決定事項やフォローアップ**
   - 例：「決定した内容を関係者に連絡する」

5. **購入や手配が必要なもの**
   - 例：「必要な機材を注文する」

### ToDoアイテムの構造
生成されるToDoアイテムには以下の情報が含まれます：

- **タイトル**: ToDoの概要
- **詳細説明**: より具体的な内容
- **優先度**: 高・中・低
- **カテゴリ**: タスクの分類
- **期日**: 明確な期限がある場合
- **チャットリンク**: 元となったチャットへのリンク

## 使用方法

### チャットリンク機能
- ToDoリストで「〇〇とのチャット」ボタンをタップすると、元のチャットに戻ることができます
- これにより、ToDo作成の背景や詳細な文脈を簡単に確認できます

## 実際の使用例

### ケース1: プロジェクト打ち合わせ（自動検出）
**チャット内容:**
```
A: 来週の金曜日までに企画書を作成していただけますか？
B: はい、承知しました。どのような内容にしましょうか？
A: 昨日話した新機能の詳細と、スケジュールも含めてください
B: 分かりました。資料も調べておきますね
```

**自動処理の流れ:**
1. 4件の新規メッセージを検出
2. 3秒後に第1段階分析開始
3. 「作業依頼と期限が含まれている」と判定（信頼度85%）
4. 第2段階で詳細分析を実行
5. 「企画書の作成」ToDoを自動生成

### ケース2: 一般的な雑談（自動スキップ）
**チャット内容:**
```
A: 今日は天気が良いですね
B: そうですね、散歩日和です
A: 今度一緒に行きましょう
```

**自動処理の流れ:**
1. 3件のメッセージを検出
2. 第1段階で「具体的なタスクなし」と判定（信頼度15%）
3. 第2段階をスキップ、ToDoは生成されない
**チャット内容:**
```
A: 来週の金曜日までに企画書を作成していただけますか？
B: はい、承知しました。どのような内容にしましょうか？
A: 昨日話した新機能の詳細と、スケジュールも含めてください
```

**生成されるToDo:**
- タイトル: 「企画書の作成」
- 詳細: 「新機能の詳細とスケジュールを含む企画書を作成する」
- 期日: 「来週の金曜日」
- 優先度: 「高」

### ケース2: 日常的なやりとり
**チャット内容:**
```
A: そういえば、あの本読み終わったら感想聞かせて
B: まだ途中なんだ。今度会った時に話そう
A: 楽しみにしてる！
```

**生成されるToDo:**
- タイトル: 「本の感想を共有」
- 詳細: 「読書完了後にAさんに感想を伝える」
- 優先度: 「低」
- カテゴリ: 「個人」

## 動作テスト方法

### 1. APIキー設定の確認
```bash
# .env.local ファイルにAPIキーが正しく設定されているか確認
cat .env.local
```

### 2. 自動分析のテスト
以下のようなメッセージを3件以上連続で送信してテスト：

**ToDo生成されるメッセージ例:**
```
「明日の会議の資料を準備しておいてください」
「来週までにプロトタイプを作成する必要があります」  
「この件について詳しく調査してみましょう」
「決定した内容を関係者に連絡します」
```

**ToDo生成されないメッセージ例:**
```
「今日はいい天気ですね」
「昨日のテレビ番組面白かったです」
「週末はどう過ごしましたか？」
```

### 3. 動作確認のポイント
- メッセージ送信後3秒待機
- コンソールログで分析状況を確認
- ToDoリストページで結果を確認
- チャットリンクが正常に動作するか確認

### APIキーエラー
```
Error: GPTからのレスポンスが空です
```
**解決方法:**
1. `.env.local`ファイルでAPIキーが正しく設定されているか確認
2. APIキーが有効で、使用制限に達していないか確認
3. アプリを再起動

### メッセージが空の場合
```
エラー: 分析するメッセージがありません
```
**解決方法:**
- チャット履歴にメッセージがあることを確認してください

### 分析結果が表示されない
**考えられる原因:**
1. チャット内容にタスクに関する情報が含まれていない
2. GPTが適切なToDoアイテムを抽出できなかった

## APIコスト管理

- GPT-4の利用には料金がかかります
- 長いチャット履歴の分析はより多くのトークンを消費します
- [OpenAI Usage Dashboard](https://platform.openai.com/usage)で使用量を監視することをお勧めします

## 注意事項

1. **プライバシー**: チャット内容がOpenAIのサーバーに送信されます
2. **精度**: GPTの分析結果が常に完璧とは限りません
3. **コスト**: API使用料金が発生します
4. **レート制限**: 短時間に大量のリクエストを送信すると制限される可能性があります

## 今後の改善予定

- [ ] 分析対象メッセージの範囲選択機能
- [ ] ToDo生成結果のプレビューと編集機能
- [ ] カスタムプロンプトの設定
- [ ] 分析結果のキャッシュ機能
- [ ] オフライン対応
